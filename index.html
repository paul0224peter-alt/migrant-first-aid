<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§»å·¥æ€¥æ•‘æŒ‡å¼• First Aid Guide</title>
    <style>
        /* æ¨£å¼å€ï¼šåªæ”¾ CSS */
        body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f9f9f9; }
        .btn-group { margin-bottom: 20px; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; cursor: pointer; border-radius: 5px; border: 1px solid #ccc; }
        #content { border: 2px solid #ff4444; border-radius: 10px; padding: 20px; margin-top: 20px; display: none; background-color: white; }
        .audio-btn { background-color: #4CAF50; color: white; border: none; }
        #cpr-metronome { margin-top: 30px; padding: 20px; border-top: 2px dashed #ccc; }
        #metro-btn { 
            background-color: #ff4444; color: white; border-radius: 50%; 
            width: 120px; height: 120px; font-weight: bold; border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <h1>ğŸš¨ æ€¥æ•‘æŒ‡å¼• (First Aid)</h1>
    
    <div class="btn-group">
        <button onclick="loadGuide('zh')">ä¸­æ–‡</button>
        <button onclick="loadGuide('vi')">Tiáº¿ng Viá»‡t (è¶Šå—)</button>
        <button onclick="loadGuide('id')">Bahasa Indonesia (å°å°¼)</button>
        <button onclick="loadGuide('th')">à¹„à¸—à¸¢ (æ³°åœ‹)</button>
    </div>

<div id="content">
    <h2 id="title"></h2>
    
    <div style="display: flex; justify-content: space-around; flex-wrap: wrap;">
        <div class="step-box">
            <img id="img1" src="" width="150" style="display:none; border-radius: 8px;">
            <p id="step1"></p>
        </div>
        <div class="step-box">
            <img id="img2" src="" width="150" style="display:none; border-radius: 8px;">
            <p id="step2"></p>
        </div>
    </div>
    
    <button class="audio-btn" onclick="speakText()">ğŸ”Š èªéŸ³æœ—è®€ (Play Audio)</button>
</div>

    <div id="cpr-metronome">
        <h3>ğŸ’“ CPR æŒ‰å£“ç¯€å¥å™¨</h3>
        <button id="metro-btn" onclick="toggleMetronome()">
            é–‹å§‹ç¯€å¥<br>(START)
        </button>
        <p>è«‹è·Ÿè‘—ã€Œå—¶ã€è²æŒ‰å£“ï¼šæ¯åˆ†é˜ 110 æ¬¡</p>
    </div>

    <script>
        let currentLang = 'zh';
        let metroInterval = null;
        let audioCtx = null;

async function loadGuide(lang) {
    currentLang = lang;
    try {
        const response = await fetch(`https://migrant-first-aid.onrender.com/guide/${lang}`);
        const data = await response.json();
        
        document.getElementById('content').style.display = 'block';
        document.getElementById('title').innerText = data.title;

        document.getElementById('step1').innerText = data.steps[0].text;
        document.getElementById('img1').src = `https://migrant-first-aid.onrender.com${data.steps[0].img}`;
        document.getElementById('img1').style.display = 'block';

        document.getElementById('step2').innerText = data.steps[1].text;
        document.getElementById('img2').src = `https://migrant-first-aid.onrender.com${data.steps[1].img}`;
        document.getElementById('img2').style.display = 'block';

    } catch (error) {
        console.error("éŒ¯èª¤ç´°ç¯€:", error);
    }
}

let synth = window.speechSynthesis;
let msg = null;

function speakText() {
    const title = document.getElementById('title').innerText;
    const s1 = document.getElementById('step1').innerText;
    const s2 = document.getElementById('step2').innerText;
    const fullText = `${title}ã€‚${s1}ã€‚${s2}`;

    // 2. å…ˆåœæ­¢æ‰€æœ‰æ­£åœ¨é€²è¡Œæˆ–æ’éšŠçš„èªéŸ³ï¼Œæ¸…ç©ºä½‡åˆ—
    synth.cancel();

    // 3. å»ºç«‹èªéŸ³ç‰©ä»¶
    msg = new SpeechSynthesisUtterance(fullText);

    // 4. è¨­å®šèªç³»
    const langMap = { 'zh': 'zh-TW', 'vi': 'vi-VN', 'id': 'id-ID', 'th': 'th-TH' };
    msg.lang = langMap[currentLang];

    // 5. æ‰‹æ©Ÿå„ªåŒ–ï¼šè¨­å®šé©ç•¶çš„èªé€Ÿèˆ‡éŸ³èª¿
    msg.rate = 0.85; 
    msg.pitch = 1.0;
    msg.volume = 1.0;

    msg.onend = function(event) {
        console.log('æ’­æ”¾å®Œç•¢');
        msg = null; 
    };

    msg.onerror = function(event) {
        console.error('èªéŸ³ç™¼ç”ŸéŒ¯èª¤', event);
    };

    synth.speak(msg);
}

        // 3. ç¯€å¥å™¨é–‹é—œ
        function toggleMetronome() {
            const btn = document.getElementById('metro-btn');

            if (metroInterval) {
                clearInterval(metroInterval);
                metroInterval = null;
                btn.innerText = "é–‹å§‹ç¯€å¥\n(START)";
                btn.style.backgroundColor = "#ff4444";
            } else {
                const bpm = 110;
                const ms = 60000 / bpm;
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                metroInterval = setInterval(playBeep, ms);
                btn.innerText = "åœæ­¢ç¯€å¥\n(STOP)";
                btn.style.backgroundColor = "#333";
            }
        }

        // 4. ç™¼å‡ºå—¶è²
        function playBeep() {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(440, audioCtx.currentTime);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }
    </script>
</body>
</html>